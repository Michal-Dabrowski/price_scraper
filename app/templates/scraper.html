<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Allegro/Ceneo Scraper v0.8</title>

    <!-- Bootstrap Core CSS -->
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <style>
    body {
        padding-top: 70px;
        /* Required padding for .navbar-fixed-top. Remove if using .navbar-static-top. Change if height of navigation changes. */
    }
    </style>

</head>
<body>

{% include 'navbar.html' %}
    <!-- Page Content -->
    <div class="container">
        <!-- /.row -->
        <br>
        {% with messages = get_flashed_messages() %}
            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-danger" role="alert"><center>{{ message }}</center></div>
                {% endfor %}
            {% endif %}
        {% endwith %}

    {% include 'progress_bar.html' %}

    {% block content %}{% endblock %}

    </div>
    <!-- /.container -->

<!-- jQuery Version 1.11.1 -->
<script src="/static/js/jquery.js"></script>
<!-- Bootstrap Core JavaScript -->
<script src="/static/js/bootstrap.min.js"></script>

<script type="text/javascript">
        var website = '{{source}}'; //a Flask variable containing "allegro" or "ceneo" string
        var button = document.getElementById('button');
        var progress_bar = document.getElementById('myBarDiv');
        var sub_progress_bar = document.getElementById('myProgressbarSub');
        var loading_circle = document.getElementById('loader-circle');
        var percent = document.getElementById('percent');
        var sub_percent = document.getElementById('percent-sub');
        var my_error = document.getElementById('errorMessage');
        var force_button = document.getElementById('force_button');

        function show_element(element) {
            element.style.display = 'block';
        }

        function hide_element(element) {
            element.style.display = 'none';
        }

        function scrap_allegro_or_ceneo(force){
            var source = new EventSource("/scrap/" + website + "/" + force);
            source.onmessage = function(event){

                if(event.data.includes('url')){
                    var data = event.data.split(' ')[0];
                    show_element(sub_progress_bar);
                    $('#my-bar-sub').css('width', data+'%').attr('aria-valuenow', data);
                    sub_percent.innerHTML = data + '%';
                }

                if(event.data.indexOf('url') == -1){
                    $('#my-bar').css('width', event.data+'%').attr('aria-valuenow', event.data);
                    percent.innerHTML = event.data + '%';
                }

                if(event.data == 100){
                    hide_element(progress_bar);
                    show_element(loading_circle);
                }

                else if(event.data == 'done'){
                    hide_element(loading_circle);
                    source.close();
                }

                else if(event.data == 'error'){
                    source.close();
                    hide_element(progress_bar);
                    show_element(my_error);
                }
            }
        }

        button.onclick = function() {
            show_element(progress_bar);
            scrap_allegro_or_ceneo(false);
        }

        force_button.onclick = function() {
            show_element(progress_bar);
            scrap_allegro_or_ceneo(true);
        }
</script>
</body>

</html>