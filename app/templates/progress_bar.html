<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Allegro/Ceneo Scraper v0.8</title>

    <!-- Bootstrap Core CSS -->
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <style>
    .loader {
        position: relative;
        border: 16px solid #f3f3f3; /* Light grey */
        border-top: 16px solid #3498db; /* Blue */
        border-bottom: 16px solid #3498db;
        border-radius: 50%;
        width: 120px;
        height: 120px;
        animation: spin 2s linear infinite;
        }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
        }
    </style>

</head>

<!-- not visible error message -->
<div id='errorMessage' class="alert alert-danger" role="alert" style="display: none;">
    <center>Dzisiejsza analiza już została wykonana. Czy jesteś pewien, że chcesz wykonać ją ponownie?
        <button class="btn btn-default" id="force_button">Chcę przeprowadzić analizę ponownie</button>
    </center>
</div>

<!-- database update loader -->
<div id="loader-circle" class="text-center" style="display: none;">
    <p>Aktualizowanie bazy danych...</p>
    <div class="loader center-block"></div>
</div>

<!-- progress bar -->
<div class="panel panel-success" id="myBarDiv" style="display: none;">
    <div class="panel-heading">
        <h3 class="panel-title">Postęp analizy (nie opuszczaj strony aż do ukończenia)</h3>
    </div>
    <div class="panel-body">
        <div class="progress" id="myProgressbarSub" style="display: none;">
                <div class="progress-bar progress-bar-success progress-bar-striped active" id="my-bar-sub" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%;">
                <div id="percent-sub">0</div>
            </div>
        </div>

        <div class="progress" id="myProgressbar">
                <div class="progress-bar progress-bar-success progress-bar-striped active" id="my-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%;">
                <div id="percent">0</div>
            </div>
        </div>


    </div>
</div>

    <!-- jQuery Version 1.11.1 -->
    <script src="/static/js/jquery.js"></script>
    <!-- Bootstrap Core JavaScript -->
    <script src="/static/js/bootstrap.min.js"></script>


<script type="text/javascript">
    var website = '{{source}}'; //a Flask variable containing "allegro" or "ceneo" string
    var button = document.getElementById('button');
    var progress_bar = document.getElementById('myBarDiv');
    var sub_progress_bar = document.getElementById('myProgressbarSub');
    var loading_circle = document.getElementById('loader-circle');
    var percent = document.getElementById('percent');
    var sub_percent = document.getElementById('percent-sub');
    var my_error = document.getElementById('errorMessage');
    var force_button = document.getElementById('force_button');

    function show_element(element) {
        element.style.display = 'block';
    }

    function hide_element(element) {
        element.style.display = 'none';
    }

    function scrap_allegro_or_ceneo(force){
        var source = new EventSource("/scrap/" + website + "/" + force);
        source.onmessage = function(event){

            if(event.data.includes('url')){
                var data = event.data.split(' ')[0];
                show_element(sub_progress_bar);
                $('#my-bar-sub').css('width', data+'%').attr('aria-valuenow', data);
                sub_percent.innerHTML = data + '%';
            }

            if(event.data.indexOf('url') == -1){
                $('#my-bar').css('width', event.data+'%').attr('aria-valuenow', event.data);
                percent.innerHTML = event.data + '%';
            }

            if(event.data == 100){
                hide_element(progress_bar);
                show_element(loading_circle);
            }

            else if(event.data == 'done'){
                hide_element(loading_circle);
                source.close();
            }

            else if(event.data == 'error'){
                source.close();
                hide_element(progress_bar);
                show_element(my_error);
            }
        }
    }

    button.onclick = function() {
        show_element(progress_bar);
        scrap_allegro_or_ceneo(false);
    }

    force_button.onclick = function() {
        show_element(progress_bar);
        scrap_allegro_or_ceneo(true);
    }


</script>